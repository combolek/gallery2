<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Gallery Remote Protocol version 2</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<style type="text/css">
h1 { font-family: sans-serif; font-size: 17pt; font-weight: bold; }
h2 { font-family: sans-serif; font-size: 14pt; font-weight: bold; }
h3 { font-family: sans-serif; font-size: 12pt; font-weight: bold; }
h4 { font-family: sans-serif; font-size: 11pt; font-weight: bold; }
p,ol,ul,body{ font-family: serif; font-size: 11pt; }
li { font-family: serif; font-size: 11pt; margin: 4px; }
.since { background-color: #FFcccc; color: #FF0000; }

samp { font-family: monospace; color: #0000aa; background-color: #FFFF99; }
body { background-color: #FFFFFF; margin: 8px; }
hr { color: black; height: 1px; width: 100%; }

table { border-style: solid; border-width: 1px; border-color: black; margin: 20px;  }

img { border-width: 0px; }
</style>
</head>
<body>

<h1>Gallery Remote Protocol version 2</h1>

<p><cite>Tim Miller</cite> &lt;<a href="mailto:tim_miller at users.sourceforge.net">tim_miller 
  at users dot sourceforge dot net</a>&gt;<br>
  <cite>Pierre-Luc Paour</cite> &lt;<a href="mailto:paour at users.sourceforge.net">paour 
  at users dot sourceforge dot net</a>&gt;</p>

<hr>

<h2><a name="toc" />Contents</a></h2>  

<ul>
  <li>1. <a href="#intro">Introduction</a></li>
  <li>2. <a href="#overview">Overview</a></li>
  <li>3. <a href="#interaction">Client-Server Interaction</a></li>
  <li>4. <a href="#requests">Requests</a></li>
  <li>5. <a href="#responses">Responses</a></li>
  <li>6. <a href="#commands">Commands</a> 
    <ol>
      <li><a href="#login"><samp>login</samp> command</a></li>
      <li><a href="#fetch-albums"><samp>fetch-albums</samp> command</a></li>
      <li><a href="#add-item"><samp>add-item</samp> command</a></li>
      <li><a href="#album-info"><samp>album-info</samp> command</a></li>
    </ol>
  </li>
  <li>Appendix A: <a href="#appendix_a">Response Status Codes</a></li>
</ul>

<hr>

<h2><a name="intro" />1. Introduction</a></h2>  

<p>This document describes version 2 of the <a href="http://gallery.menalto.com/">Gallery</a> 
  remote application protocol as of version 1.3.2 of Gallery.</p>
<p>Also see documentation of the <a href="gal_remote_proto-1.html">previous version</a> 
  of the protocol.</p>
  


<hr>

<h2><a name="overview" />2. Overview</a></h2>

<p>Gallery remote queries and sends information from a Gallery server through 
  a protocol based on HTTP and form-data. The protocol leverages the same user 
  authentication (and session cookies) as the web/HTML interface to the site. 
  It is implemented in the PHP source file <samp><a href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/gallery/gallery/gallery_remote2.php?rev=1.6&amp;content-type=text/vnd.viewcvs-markup">gallery_remote2.php</a></samp>.</p>

<p>Each query from client to server corresponds to one action.  Multiple actions require multiple HTTP requests.</p>

<p>The protocol is stateful and depends on the client supporting cookies.  The
client must provide login credentials for the session to be validated by sending a
login request before any other requests will succeed.</p>

<p>Permissions for actions performed by <samp>gallery_remote2.php</samp> are controlled in 
  the same way they are controlled for regular web/HTML users of Gallery. <samp>init.php</samp> 
  is called before each request is processed by the server.</p>

<hr>

<h2><a name="interaction" />3. Client-Server Interaction</a></h2>

<p>All client-server interaction follows the standard HTTP model.  The client initiates all interactions with a <em><a href="#requests">request</a></em>.  The server always responds with one <em><a href="#responses">response</a></em>.  The data format of each request is HTTP form-data key/value pairs.  The data format of each response is plain text key/value pairs.</p>

<p>Each request specifies a <em><a href="#commands">command</a></em> value (and possibly some corresponding parameters) which determines the content of the response. Command-specific responses are defined in the context of each <em>command</em> below).</p>

<hr>

<h2><a name="requests" />4. Requests</a></h2>

<p>Each request from the client is sent to the server through an HTTP POST. 
Parameters of the request are expressed as HTTP form data. Form data uses a
key / value format referred to in
<a href="http://www.w3.org/TR/REC-html40/interact/forms.html#control-name">the
spec</a> as "control-name / current value."  Here we simply refer to "<em>key</em>"
and "<em>value</em>".</p>

<p>Each request must specify a command (the "<samp>cmd</samp>" key).  Depending
on which command is specified, other key/value pairs are required in the form-data
set (as parameters).</p>

<p>Each request must specify a protocol version (the <samp>protocol_version</samp> 
  key).</p>
  
<p>The server's response to the <a href="#login">login</a> command includes the version of the protocol it implements (with the <samp>server_version</samp> key). Protocol 
  numbers obey the following convention:<br><br><em>maj</em><samp>.</samp><em>min</em> <br><br>
  where <em>maj</em> is the major version number and <em>min</em> is the minor 
  version number. Different major versions of the protocol use different <samp>gallery_remote</samp><em>maj</em><samp>.php</samp> 
  files. Each such file may provide support for various minor versions.</p>

<p>Each command is described in the <a href="#commands">Commands</a> section below.  After a brief description of the command, template form data appears and the contents of the server's response is described.</p>

<hr>

<h2><a name="responses" />5. Responses</a></h2>

<p>After the client POSTs a request, the server sends a <em>response</em> to the client.  The format of the response is a key/value format compatible with the Java "<a href="http://java.sun.com/j2se/1.4.1/docs/api/java/util/Properties.html">Properties</a>" stream format.</p>

<p>Each response must contain at least the keys: <samp>status</samp> and <samp>status_text</samp>.</p>

<p>The value associated with the <samp>status</samp> key is an integer status code
(the codes are defined in <a href="#appendix_a">Appendix A</a>.  For example, if the
server was able to complete the command in the client's request, the value of the
<samp>status</samp> code will be <a href="#appendix_a">GR_STAT_SUCCESS</a>.</p>

<p>The <samp>status</samp> key is definitive, yet the <samp>status_text</samp> may contain human-readable additional information (likely to be English language only).</p>

<p>Otherwise, if the server was not able to successfully complete the request, the status will be a non-zero integer (see <a href="#appendix_a">Appendix A: Response Status Codes</a>).
</p>

<hr>

<h2><a name="commands" />6. Commands</a></h2>

<ol>
  <li> 
    <h3><a name="login" /><samp>login</samp></a> command</h3>
    <p>This command adds the proper user object to the 
      session (if the username and password are correct). It also returns to the client the version of the protocol the server 
      is prepared to support.</p>
    <ul>
      <li> 
        <h4>Context</h4>
        <p>A request with the <samp>login</samp> command may be made at any time 
          &mdash; there are no prerequisites.</p>
      </li>
      <li> 
        <h4>Form Data</h4>
        <p><samp>cmd=login<br>
          protocol_version=2.0</samp><em></em><br>
          <samp>uname=</samp><em>gallery-user-name</em><samp><br>
          password=</samp><em>cleartext-password</em><br>
        </p>
        where <em>gallery-user-name</em> is a valid gallery user name and 
        <em>cleartext-password</em> is the corresponding password.
        <p>
        </p>
      </li>
      <li> 
        <h4>Results</h4>
        <p>
        <samp>status=</samp><em>result-code</em><br>
        <samp>status_text=</samp><em>explanatory-text</em><br>
        <samp>server_version=</samp><em>major-version</em><samp>.</samp><em>minor-version</em><br>
        </p>
        <p>If the <em>result-code</em> is equal to <a href="#appendix_a">GR_STAT_SUCCESS</a>, the login completed
        successfully and the user's session has been updated.  Any other command can now be used in requests to this server.
        </p>
      </li>
    </ul>
  </li>
  <li> 
    <h3><a name="fetch-albums" /><samp>fetch-albums</samp></a> command</h3>
    <p>The <samp>fetch-albums</samp> command asks the server to return a list 
      of all albums (visible with the client's logged in user permissions).</p>
    <ul>
      <li> 
        <h4>Context</h4>
        <p>A request with the <samp>login</samp> command must be made before the 
          <samp>fetch-albums</samp> command is used.</p>
      </li>
      <li> 
        <h4>Form Data</h4>
        <p><samp>cmd=fetch-albums<br>
          protocol_version=2.0</samp></p>
      </li>
      <li>
        <h4>Results</h4>
        <p>
        
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<samp>status=</samp><em>result-code</em><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<samp>status_text=</samp><em>explanatory-text</em><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/<samp>album.name.</samp><em>ref-num</em><samp>=</samp><em>album-url-name</em><br>
0...<em>n</em> |<samp>album.title.</samp><em>ref-num</em><samp>=</samp><em>album-display-name</em><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<samp>album.parent.</samp><em>ref-num</em><samp>=</samp><em>parent-ref-num</em><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<samp>album_count=</samp><em>number-of-albums</em>
		</p>
		
        <p>If the <em>result-code</em> is equal to <a href="#appendix_a">GR_STAT_SUCCESS</a>, the album data was fetched successfully</p>
        <p>If successful, a response to the <samp>fetch-albums</samp> command 
          returns three keys for each album in the gallery, where <br></p>
          
          <ul>
          	<li><em>ref-num</em> is a reference number,</li>
          	<li><em>album-url-name</em> is the name of the partial URL for the gallery,</li>
          	<li><em>album-display-name</em> is the gallery's visual name,</li>
          	<li>and <em>parent-ref-num</em> refers to some other album's <em>ref-num</em>.</li>
          </ul><br>
          <p>A <em>parent-ref-num</em> of <samp>0</samp> indicates that the album is a "top-level" album (it has no parent).
        </p>
          <p>The number of albums in the response is returned as
<em>number-of-albums</em>.</p>
      </li>
    </ul>
  </li>
  <li> 
    <h3><a name="add-item" /><samp>add-item</samp></a> command</h3>
    <p>This command asks the server to add a photo to a specified album.</p>
    <ul>
      <li> 
        <h4>Context</h4>
        <p>A request with the <samp>login</samp> command must be made before the 
          <samp>add-item</samp> command is used.</p>
      </li>
      <li> 
        <h4>Form Data</h4>
        <p><samp>cmd=add-item<br>
          protocol_version=2.0<br>
          set_albumName=</samp><em>album name</em><samp><br>
          userfile=</samp><em>form-data-encoded image data</em><br>
          <samp>caption=</samp><em>caption</em> [since 2.0]<br>
          <samp>force_filename=</samp><em>name of the file on the server</em> 
          [since 2.0]</p>
      </li>
      <li> 
        <h4>Results</h4>
         <samp>status=</samp><em>result-code</em><br>
        <samp>status_text=</samp><em>explanatory-text</em><br>
       <p>If the <em>result-code</em> equal to
<a href="#appendix_a">GR_STAT_SUCCESS</a>, the file upload succeeded.
        </p>
      </li>
    </ul>
  </li>
  <li> 
    <h3><a name="album-info" id="album-info" /><samp>album-info</samp></a> command [since 2.0]</h3>
    <p>This command asks the server for information on an album.</p>
    <ul>
      <li> 
        <h4>Context</h4>
        <p>A request with the <samp>login</samp> command must be made before the 
          <samp>album-info</samp> command is used.</p>
      </li>
      <li> 
        <h4>Form Data</h4>
        <p><samp>cmd=album-info<br>
          protocol_version=2.0<br>
          set_albumName=</samp><em>album name</em></p>
      </li>
      <li> 
        <h4>Results</h4>
        <samp>status=</samp><em>result-code</em><br>
        <samp>status_text=</samp><em>explanatory-text</em><br>
        <p>If the <em>result-code</em> is equal to GR_STAT_SUCCESS, the request succeeded.
        </p>
        <p><samp>auto-resize=</samp>size, in pixels, to which the server will resize pictures on upload.</p><p>If the value is <samp>0</samp> (zero), the Gallery server does not intend to resize uploaded images.</p>
      </li>
    </ul>
  </li>
</ol>

<hr>

<h2><a name="appendix_a" />Appendix A: Response Status Codes</a></h2>

<table>
<thead>
<tr>
	<th>Status name</th>
	<th>Code</th>
	<th>Description</th>
</tr>
</thead>
<tbody>
<tr><td>GR_STAT_SUCCESS</td><td>0</td><td>The command the client sent in the request completed successfully.  The data (if any) in the response should be considered valid.</td></tr>

<tr><td>GR_STAT_PROTO_MAJ_VER_INVAL</td><td>101</td><td>The protocol major version the client is using is not supported.</td></tr>
<tr><td>GR_STAT_PROTO_MIN_VER_INVAL</td><td>102</td><td>The protocol minor version the client is using is not supported.</td></tr>
<tr><td>GR_STAT_PROTO_VER_FMT_INVAL</td><td>103</td><td>The format of the protocol version string the client sent in the request is invalid.</td></tr>
<tr><td>GR_STAT_PROTO_VER_MISSING</td><td>104</td><td>The request did not contain the required <samp>protocol_version</samp> key.</td></tr>

<tr><td>GR_STAT_PASSWD_WRONG</td><td>201</td><td>The password and/or username the client send in the request is invalid.</td></tr>
<tr><td>GR_STAT_LOGIN_MISSING</td><td>202</td><td>The client used the login command in the request but failed to include either the username or password (or both) in the request.</td></tr>
</tbody>
</table>

</body>
</html>